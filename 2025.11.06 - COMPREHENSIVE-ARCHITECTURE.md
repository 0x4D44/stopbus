# Stop the Bus - Comprehensive Architecture Documentation

**Document Date:** 2025-11-06
**Project:** Stop the Bus (Preservation + Modernization)
**Repository:** github.com/[owner]/stopbus
**License:** MIT

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Project Overview](#project-overview)
3. [System Architecture](#system-architecture)
4. [Component Documentation Index](#component-documentation-index)
5. [Data Flow Diagrams](#data-flow-diagrams)
6. [Technology Stack](#technology-stack)
7. [Development Workflow](#development-workflow)
8. [Migration Status](#migration-status)
9. [Integration Points](#integration-points)
10. [Future Roadmap](#future-roadmap)

---

## Executive Summary

**Stop the Bus** is a preservation and modernization project for a 1993 Windows card game originally written in Turbo Pascal by Martin Davidson at Oxford University. This repository serves dual purposes:

1. **Historical Archive:** Preserves the complete original Pascal codebase, resources, and build artifacts as a documented historical artifact
2. **Modern Implementation:** Provides a feature-parity Rust reimplementation using windows-rs targeting Windows 10/11

### Project Stats

| Metric | Value |
|--------|-------|
| **Total Lines of Code** | ~6,200 lines |
| **Legacy Pascal** | 2,528 lines (STOPBUS.PAS) |
| **Modern Rust** | 3,642 lines (stopbus-core: 1,072 + stopbus-ui: 2,571) |
| **Documentation** | 6 architecture docs, 7 technical docs |
| **Migration Phase** | C-D (60% complete) |
| **First Release** | v1.0 (1993-12-06) |
| **Current Version** | v2.0 (Rust modernization) |
| **License** | MIT (modern), Shareware (original) |

### Key Achievements

âœ… **Phase A:** Complete reverse engineering and documentation
âœ… **Phase B:** All assets extracted and converted (OS/2 â†’ Windows V3 bitmaps)
âœ… **Phase C:** Rust workspace bootstrapped with working Win32 UI
ğŸ”„ **Phase D:** Core game logic port in progress (60% complete)
â³ **Phase E-G:** UI interaction, help system, packaging (pending)

---

## Project Overview

### Historical Context

**Original Game:**
- **Author:** Martin (M.G.) Davidson, Hertford College, Oxford University
- **Language:** Turbo Pascal for Windows 1.5
- **Platform:** Windows 3.1 (with CTL3D.DLL for 3D controls)
- **Release:** v1.11 (May 9, 1994) after 4 bug fixes
- **Distribution:** Shareware (Â£5 UK / $10 USD)
- **Card Graphics:** Microsoft standard card bitmaps (OS/2 format)

**Modern Reimplementation:**
- **Language:** Rust (stable 1.90.0+)
- **UI Framework:** Direct Win32 APIs via windows-rs 0.58
- **Platform:** Windows 10/11 (64-bit)
- **Architecture:** Separated crates (core logic + UI shell)
- **Build System:** Cargo with embed-resource for Win32 resources

### Game Rules Summary

**Players:** 4 (1 human + 3 AI)
**Starting Lives:** 3 per player
**Goal:** Be the last player with lives remaining

**Gameplay:**
1. Each player dealt 3 cards
2. Players take turns swapping cards with stack to improve hand score
3. **Scoring:** Best suit-matched combination (Ace=11, face cards=10, others=face value)
4. **Stop the Bus:** Score of 31 immediately ends round
5. **Sticking:** Player can "stick" at score >25 (no more swaps)
6. **Round End:** Lowest scorer(s) lose a life, or all except "stopper" if someone hits 31
7. **Game End:** Last player standing wins

---

## System Architecture

### High-Level Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        REPOSITORY ROOT                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   LEGACY PRESERVATION     â”‚  â”‚   MODERN RUST BUILD           â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ STOPBUS.PAS (2,528) â”‚  â”‚   â”œâ”€â”€ Cargo.toml (workspace)  â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ CTL3D.PAS           â”‚  â”‚   â”œâ”€â”€ crates/                 â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ ABOUT.RC            â”‚  â”‚   â”‚   â”œâ”€â”€ stopbus-core/       â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ STOPBUS.RES (100KB) â”‚  â”‚   â”‚   â”‚   â””â”€â”€ lib.rs (1,072)  â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ STOPBUS.EXE         â”‚  â”‚   â”‚   â””â”€â”€ stopbus-ui/         â”‚  â”‚
â”‚  â”‚   â””â”€â”€ HELP/               â”‚  â”‚   â”‚       â”œâ”€â”€ main.rs (2,571)  â”‚  â”‚
â”‚  â”‚       â”œâ”€â”€ STOPBUS.HLP     â”‚  â”‚   â”‚       â”œâ”€â”€ build.rs (59)    â”‚  â”‚
â”‚  â”‚       â””â”€â”€ STOPBUS.RTF     â”‚  â”‚   â”‚       â””â”€â”€ resources/       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚           â”œâ”€â”€ stopbus.rc   â”‚  â”‚
â”‚                                  â”‚   â”‚           â””â”€â”€ cards/*.bmp â”‚  â”‚
â”‚                                  â”‚   â””â”€â”€ target/                  â”‚  â”‚
â”‚                                  â”‚       â””â”€â”€ release/             â”‚  â”‚
â”‚                                  â”‚           â””â”€â”€ stopbus.exe      â”‚  â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   DOCUMENTATION           â”‚  â”‚   ASSETS & TOOLS              â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ README.md           â”‚  â”‚   â”œâ”€â”€ assets/                 â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ CLAUDE.md           â”‚  â”‚   â”‚   â”œâ”€â”€ cards-os2/          â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ AGENTS.md           â”‚  â”‚   â”‚   â””â”€â”€ original-icons/     â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ docs/               â”‚  â”‚   â”œâ”€â”€ tools/                  â”‚  â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ *-notes.md      â”‚  â”‚   â”‚   â”œâ”€â”€ extract_cards.py    â”‚  â”‚
â”‚  â”‚   â”‚   â””â”€â”€ *-plan.md       â”‚  â”‚   â”‚   â””â”€â”€ update_about.py     â”‚  â”‚
â”‚  â”‚   â””â”€â”€ wrk_docs/           â”‚  â”‚   â””â”€â”€ installers/             â”‚  â”‚
â”‚  â”‚       â””â”€â”€ 2025.11.06-*.md â”‚  â”‚       â””â”€â”€ StopTheBus.iss      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rust Workspace Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CARGO WORKSPACE                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  stopbus-core (Library Crate)                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Public API                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ GameState::new(seed) -> Self                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ start_fresh() -> DriveReport                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ human_swap_with_stack(slot) -> Option<DriveReport> â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ human_stick() -> Option<DriveReport>               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ advance_after_human_turn() -> DriveReport          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ card_rank(), card_suit(), card_points()            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ hand_max_score(&[Option<CardId>; 3]) -> u8         â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Internal Implementation                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ shuffle_deck() - 100-iteration Fisher-Yates       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ deal_round() - Shuffles & deals to alive players  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ execute_auto_turn() - AI logic (>25 stick, 2-swap)â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ finish_round() - Life loss, game-over detection   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ drive_round_step() - State machine controller     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  Dependencies: rand = "0.8" (seeded RNG)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â–²                                   â”‚
â”‚                               â”‚ uses as library                   â”‚
â”‚                               â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  stopbus-ui (Binary Crate - Windows Executable)           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Win32 UI Layer                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ main() - Message loop (GetMessageW/DispatchMessageW)â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ window_proc() - Main WndProc (WM_PAINT, WM_COMMAND)â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ options_dialog_proc() - Options dialog handler     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ about_dialog_proc() - About dialog handler         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ cheat_*_wnd_proc() - Cheat window handlers (3x)    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  WindowState (UI State Management)                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ game: GameState - Core game logic                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ cards: Vec<HBITMAP> - Card bitmaps (1-52)          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ legacy_module: Option<HMODULE> - STOPBUS.RES       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ cheat_*_window: Option<HWND> - Cheat windows       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ options_*: bool - Cheat/save settings              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ pending_turns: VecDeque<usize> - AI turn queue     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  build.rs (Resource Embedding)                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Compiles resources/stopbus.rc via embed-resource   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Validates card BMPs (Windows V3, not OS/2)         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Tracks resource dependencies for rebuild           â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  Dependencies: windows="0.58", stopbus-core, embed-resourceâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Documentation Index

### Detailed Architecture Documents

This comprehensive document synthesizes the following detailed component analyses:

1. **[2025.11.06 - legacy-pascal-analysis.md](2025.11.06%20-%20legacy-pascal-analysis.md)** (5,509 bytes)
   - Original 1993 Turbo Pascal implementation
   - Version history (v1.0 â†’ v1.11)
   - Class hierarchy (TCardApp, TMainWindow, Dialogs)
   - Game logic algorithms (AutoPlay, Shuffle, Scoring)
   - Side-by-side comparison with Rust implementation

2. **[2025.11.06 - project-structure-overview.md](2025.11.06%20-%20project-structure-overview.md)** (40,097 bytes)
   - Complete repository structure map
   - Documentation ecosystem (README, AGENTS, CLAUDE.md)
   - Development workflow and Git practices
   - Migration timeline (Phases A-G) with progress bars
   - Historical artifacts and preservation practices

3. **[2025.11.06 - resource-build-pipeline.md](2025.11.06%20-%20resource-build-pipeline.md)** (2,921 bytes)
   - Dual resource architecture (legacy + embedded)
   - OS/2 â†’ Windows V3 bitmap conversion process
   - Build pipeline with timing metrics
   - Resource ID mapping (1-54 for cards)
   - Outstanding issues (WinHelp migration)

4. **[2025.11.06 - stopbus-core-architecture.md](2025.11.06%20-%20stopbus-core-architecture.md)** (Comprehensive)
   - Pure Rust game logic library
   - Complete data structure documentation (GameState, DriveReport, GameEvent)
   - Game algorithms (shuffling, scoring, AI logic, round completion)
   - Public API reference with usage examples
   - Testing infrastructure and coverage

5. **[2025.11.06 - stopbus-ui-architecture.md](2025.11.06%20-%20stopbus-ui-architecture.md)** (Comprehensive)
   - Win32 GUI implementation via windows-rs
   - Message-driven architecture (WndProc handlers)
   - WindowState management
   - GDI rendering pipeline
   - Registry persistence
   - Cheat window system

### Supporting Documentation (docs/)

- **stopbus-architecture-notes.md:** Legacy Pascal code analysis
- **resource-id-map.md:** Pascal-to-Rust resource ID mappings
- **help-assets-inventory.md:** WinHelp migration planning
- **resource-embedding-plan.md:** Build-time resource strategy
- **resource-reuse-plan.md:** Legacy STOPBUS.RES reuse approach
- **card-bitmap-normalization-log.md:** OS/2 format conversion details

### Process Documentation

- **2025.09.20 - Migration & updating plan.md:** Phased modernization roadmap
- **AGENTS.md:** Repository guidelines for contributors/AI agents
- **CLAUDE.md:** Claude Code integration guide

---

## Data Flow Diagrams

### Game Initialization Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   main()    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. GetModuleHandleW()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ register_window_classâ”‚ â—„â”€â”€ Register "StopBusMainWindow"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     with window_proc callback
       â”‚
       â”‚ 2. Box::new(WindowState::new(instance))
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WindowState::new()                                     â”‚
â”‚  â”œâ”€â”€ load_legacy_resource_module()                     â”‚
â”‚  â”‚   â””â”€â”€ LoadLibraryExW("STOPBUS.RES") â†’ Option<HMODULE>
â”‚  â”œâ”€â”€ Load card bitmaps (IDs 1-54)                      â”‚
â”‚  â”‚   â””â”€â”€ LoadBitmapW(resource_instance, id)            â”‚
â”‚  â”œâ”€â”€ registry_read_*() for settings & positions        â”‚
â”‚  â””â”€â”€ GameState::new(None) â†’ Random seed                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. create_main_window(instance, state_ptr)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CreateWindowExW()                         â”‚
â”‚  â””â”€â”€ Passes state_ptr in lpParam           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ WM_CREATE
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  window_proc(WM_CREATE)                    â”‚
â”‚  â”œâ”€â”€ Extract state_ptr from lpCreateParams â”‚
â”‚  â”œâ”€â”€ SetWindowLongPtrW(GWLP_USERDATA)      â”‚
â”‚  â”œâ”€â”€ create_menus()                        â”‚
â”‚  â”œâ”€â”€ CreateWindowExW() for buttons (4x)    â”‚
â”‚  â”œâ”€â”€ register_cheat_window_classes()       â”‚
â”‚  â”œâ”€â”€ create_cheat_*_window() if enabled    â”‚
â”‚  â””â”€â”€ PostMessageW(WM_APP_START)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ WM_APP_START
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  window_proc(WM_APP_START)                 â”‚
â”‚  â”œâ”€â”€ state.game.start_fresh()              â”‚
â”‚  â”‚   â”œâ”€â”€ GameState::start_game()           â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ Reset lives to [3,3,3,3]      â”‚
â”‚  â”‚   â”‚   â””â”€â”€ shuffle_deck() (100 iter)     â”‚
â”‚  â”‚   â”œâ”€â”€ start_new_round()                 â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ deal_round()                  â”‚
â”‚  â”‚   â”‚   â””â”€â”€ drive_round_step()            â”‚
â”‚  â”‚   â”‚       â””â”€â”€ â†’ DriveReport              â”‚
â”‚  â”‚   â””â”€â”€ Returns DriveReport                â”‚
â”‚  â”œâ”€â”€ Process events (MessageBoxW)          â”‚
â”‚  â”œâ”€â”€ Update awaiting_human flag            â”‚
â”‚  â””â”€â”€ InvalidateRect() â†’ WM_PAINT           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ WM_PAINT
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  window_proc(WM_PAINT)                     â”‚
â”‚  â””â”€â”€ paint_main_window(hwnd, state)        â”‚
â”‚      â”œâ”€â”€ BeginPaint()                      â”‚
â”‚      â”œâ”€â”€ FillRect(BACKGROUND_COLOR)        â”‚
â”‚      â”œâ”€â”€ BitBlt(stack card)                â”‚
â”‚      â”œâ”€â”€ BitBlt(human hand cards Ã— 3)      â”‚
â”‚      â”œâ”€â”€ TextOutW(lives, scores, labels)   â”‚
â”‚      â””â”€â”€ EndPaint()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Game Running
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message Loop (main)                       â”‚
â”‚  while GetMessageW(&mut msg) {             â”‚
â”‚    TranslateMessage(&msg);                 â”‚
â”‚    DispatchMessageW(&msg); â”€â”€â”€â”            â”‚
â”‚  }                             â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â””â”€â”€â–º window_proc(various messages)
```

### Human Turn Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Human Turn (Player 0)                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                    â”‚
          WM_LBUTTONDOWN       WM_LBUTTONDOWN
          (card slot)          (stack card)
                â”‚                    â”‚
                â–¼                    â–¼
    pending_card = Some(slot)   stack_pressed = true
                â”‚                    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                     WM_LBUTTONUP
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                â”‚
      If pending_card                 If stack_pressed
          â”‚                                â”‚
          â–¼                                â–¼
  game.human_swap_with_stack(slot)   game.human_draw_next_card()
          â”‚                                â”‚
          â”‚ Returns Option<DriveReport>    â”‚
          â”‚                                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ User can now:         â”‚
              â”‚ 1. Swap more cards    â”‚
              â”‚ 2. Draw next (if OK)  â”‚
              â”‚ 3. Click "Stick"      â”‚
              â”‚ 4. Click "OK"         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚               â”‚
    ID_STICK_BUTTON  ID_DEAL_BUTTON  ID_OK_BUTTON
          â”‚               â”‚               â”‚
          â–¼               â–¼               â–¼
  game.human_stick() human_draw_next() advance_after_human_turn()
          â”‚               â”‚               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   DriveReport
                          â”‚
                          â”œâ”€â”€â–º events: Vec<GameEvent>
                          â”œâ”€â”€â–º awaiting_human: bool
                          â”œâ”€â”€â–º winner: Option<usize>
                          â””â”€â”€â–º turn_sequence: Vec<usize>
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                â”‚
    If awaiting_human         If !awaiting_human
    (stick was invalid)       (advance succeeded)
          â”‚                                â”‚
     Stay in turn                   Start turn timer
          â”‚                                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                Process AI turns
                       â”‚
                       â””â”€â”€â–º Back to human turn or game over
```

### AI Turn Automation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Turn (Players 1-3)                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            drive_round_step() loop
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
  Current = 0                     Current = AI (1-3)
  (handled separately)                  â”‚
                                        â–¼
                            execute_auto_turn(player)
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                               â”‚
                  Score > 25?                      Score â‰¤ 25
                        â”‚                               â”‚
                        â–¼                               â–¼
                mark_player_sticking()        try_swap_for_improvement()
                        â”‚                     (require_gt_six = true)
                    End turn                            â”‚
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚                               â”‚
                                  Swap successful?                 No swap
                                        â”‚                               â”‚
                                    End turn                            â–¼
                                                          advance_stack_pointer()
                                                                        â”‚
                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                          â”‚                           â”‚
                                                    Deck overflow?                Success
                                                          â”‚                           â”‚
                                                      End turn                        â–¼
                                                              try_swap_for_improvement()
                                                              (require_gt_six = false)
                                                                        â”‚
                                                                    End turn
                        â”‚
                        â””â”€â”€â–º next_alive_after(current)
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                               â”‚
                  Next player found              No next player
                        â”‚                               â”‚
            current_player = next              finish_round()
                        â”‚                               â”‚
                        â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚               â”‚                               â”‚
                        â”‚         Continue                         GameOver
                        â”‚         (new round)                   (winner/draw)
                        â”‚               â”‚                               â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                                  DriveReport
                                        â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                               â”‚
              If awaiting_human              If turn_sequence.len() > 0
              (human's turn next)            (AI turns to animate)
                        â”‚                               â”‚
                  Return report               pending_turns.push_back(turns)
                to window_proc                          â”‚
                        â”‚                     SetTimer(TURN_TIMER_ID, 500ms)
                        â”‚                               â”‚
                        â”‚                         WM_TIMER fires
                        â”‚                               â”‚
                        â”‚                     Pop turn from queue
                        â”‚                               â”‚
                        â”‚                 turn_indicator_override = Some(turn)
                        â”‚                               â”‚
                        â”‚                         InvalidateRect()
                        â”‚                               â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                WM_PAINT shows
                                AI turn indicator
```

### Resource Loading Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Resource Loading (WindowState::new)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         load_legacy_resource_module()
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
  Path::new("STOPBUS.RES")         File doesn't exist
       .exists()?                         â”‚
         â”‚                               â”‚
         â–¼                               â–¼
    LoadLibraryExW(                 Return None
      "STOPBUS.RES",                (use embedded)
      LOAD_LIBRARY_AS_DATAFILE)
         â”‚
         â–¼
    Some(HMODULE) â”€â”€â”€â”
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                                    â”‚
  legacy_module.is_some()                      legacy_module.is_none()
         â”‚                                                    â”‚
         â–¼                                                    â–¼
  resource_instance =                          resource_instance =
  HINSTANCE(legacy_module.0)                   instance (embedded)
         â”‚                                                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
      Load from STOPBUS.RES          Load from embedded
      (OS/2 format BMPs)             (Windows V3 BMPs)
              â”‚                               â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                  For id in 1..=54:
                              â”‚
                              â–¼
              LoadBitmapW(resource_instance, id)
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
        RT_BITMAP found                 Not found
              â”‚                               â”‚
              â–¼                               â–¼
        Return HBITMAP                  Return Error
              â”‚
              â””â”€â”€â–º Store in WindowState:
                   â€¢ cards: Vec<HBITMAP> (1-52)
                   â€¢ card_back: HBITMAP (53)
                   â€¢ card_cross: HBITMAP (54)
```

---

## Technology Stack

### Modern Rust Build

**Language:** Rust 1.90.0+ (stable channel)

**Core Dependencies:**
- **stopbus-core crate:**
  - `rand = "0.8"` with `std` feature (deck shuffling)

- **stopbus-ui crate:**
  - `windows = "0.58"` with features:
    - `Win32_Foundation`
    - `Win32_UI_WindowsAndMessaging`
    - `Win32_Graphics_Gdi`
    - `Win32_System_LibraryLoader`
    - `Win32_System_Registry`
    - `Win32_UI_Input`
    - `Win32_UI_Input_KeyboardAndMouse`

- **Build Dependencies:**
  - `embed-resource = "3.0"` (compile-time resource embedding)

**Toolchain Requirements:**
- Rust stable (1.90.0+)
- MSVC toolchain (required for windows-rs)
- Windows 10/11 SDK

### Legacy Pascal Build (Reference Only)

**Language:** Turbo Pascal for Windows 1.5

**Tools:**
- Borland Resource Compiler (rc.exe)
- Microsoft Help Compiler 3.1 (hc31.exe)
- CTL3D.DLL (Microsoft 3D control library)

**Platform:** Windows 3.1/95 (for testing in VM)

### Asset Pipeline

**Conversion Tools:**
- **Python 3.x** for conversion scripts:
  - `tools/extract_cards.py` - OS/2 â†’ Windows V3 BMP conversion
  - `tools/update_about_text.py` - Resource text manipulation

**Resource Inspection:**
- Resource Hacker (GUI)
- dumpbin (CLI, from Visual Studio)

### Packaging

**Installer:** Inno Setup 6 (`installers/StopTheBus.iss`)
**CI/CD:** GitHub Actions (`.github/workflows/release.yml`)
**Distribution:** ZIP or MSIX package

---

## Development Workflow

### Quick Start (Modern Rust)

```bash
# Clone repository
git clone https://github.com/[owner]/stopbus
cd stopbus

# Validate all crates
cargo check

# Build debug
cargo build

# Build release (optimized)
cargo build --release
# Output: target\release\stopbus.exe

# Run tests
cargo test

# Run specific crate tests
cargo test -p stopbus-core

# Format code
cargo fmt

# Lint with Clippy
cargo clippy -- -D warnings
```

### Making Changes

**Core Logic Changes:**
1. Edit `crates/stopbus-core/src/lib.rs`
2. Write failing test (TDD)
3. Implement minimal fix
4. Run `cargo test -p stopbus-core`
5. Refactor while keeping tests green
6. Run `cargo fmt` and `cargo clippy`

**UI Changes:**
1. Edit `crates/stopbus-ui/src/main.rs`
2. Update resources in `crates/stopbus-ui/resources/` if needed
3. Build and test manually on Windows 10/11
4. Verify rendering and interactions

**Resource Changes:**
1. Update files in `crates/stopbus-ui/resources/`
2. Modify `stopbus.rc` for dialogs/menus
3. Rebuild (build.rs embeds resources automatically)
4. Verify with Resource Hacker or dumpbin

### Testing Strategy

**Unit Tests (stopbus-core):**
- Scoring calculations
- Deck shuffling
- Player state transitions
- Round completion logic
- `cargo test -p stopbus-core`

**Integration Tests (Manual):**
- Launch `target\release\stopbus.exe`
- Play through complete game
- Test all dialogs (Options, About)
- Verify card rendering and interactions
- Test cheat windows

**Legacy Parity Tests:**
- Run `STOPBUS.EXE` in Windows 3.1/95 VM
- Compare behavior with Rust version
- Document differences

### Commit Guidelines

**Format:**
```
<imperative-verb> <concise-description>

- Detail 1
- Detail 2

Tested: <test-commands>
Artifacts: <binary-hashes>

Fixes #<issue-number>
```

**Example:**
```
Bootstrap Rust workspace with card rendering

- Add stopbus-core crate for game logic
- Add stopbus-ui crate with Win32 message loop
- Extract card bitmaps from STOPBUS.RES
- Implement resource embedding in build.rs

Tested: cargo check, manual smoke test
Artifacts: target/release/stopbus.exe (SHA256: abc123...)

Fixes #12
```

---

## Migration Status

### Overall Progress: 60% Complete

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase A: Reverse Engineering & Documentation  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% â”‚
â”‚ Phase B: Asset Extraction & Conversion        [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% â”‚
â”‚ Phase C: Rust Project Bootstrap               [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100% â”‚
â”‚ Phase D: Core Logic Port                      [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘]  60% â”‚
â”‚ Phase E: UI & Interaction Layer               [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]   0% â”‚
â”‚ Phase F: Help & Documentation Refresh         [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]   0% â”‚
â”‚ Phase G: Packaging & QA                       [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]   0% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Detailed Status

**âœ… Phase A: Reverse Engineering (COMPLETE)**
- [x] Architecture notes for Pascal code
- [x] Resource ID mapping
- [x] Game logic documentation
- [x] UI flow analysis

**âœ… Phase B: Asset Extraction (COMPLETE)**
- [x] STOPBUS.RES decompiled
- [x] Card bitmaps extracted (54 BMPs)
- [x] OS/2 â†’ Windows V3 conversion
- [x] Icon resources extracted
- [x] Help assets unpacked

**âœ… Phase C: Rust Bootstrap (COMPLETE)**
- [x] Cargo workspace created
- [x] stopbus-core library initialized
- [x] stopbus-ui executable created
- [x] Resource embedding pipeline working
- [x] Minimal window displays

**ğŸ”„ Phase D: Core Logic Port (60% COMPLETE)**
- [x] Deck and card structures
- [x] Shuffling algorithm (100-iteration)
- [x] Player state representation
- [x] Basic scoring logic
- [x] AI turn logic (AutoPlay equivalent)
- [ ] Turn sequencing (in progress)
- [ ] Life tracking system
- [ ] Complete scoring rules
- [ ] Game state machine
- [ ] Unit test coverage expansion

**â³ Phase E: UI & Interaction (PENDING)**
- [ ] Menu command wiring
- [ ] Dialog implementations complete
- [ ] Card drag/drop interactions
- [ ] Event handlers connected
- [ ] GDI rendering polished
- [ ] Cheat window functionality verified

**â³ Phase F: Help & Documentation (PENDING)**
- [ ] WinHelp â†’ HTML/Markdown conversion
- [ ] Help viewer implementation
- [ ] Context-sensitive help mapping
- [ ] User documentation updated

**â³ Phase G: Packaging & QA (PENDING)**
- [ ] GitHub Actions pipeline
- [ ] Inno Setup installer
- [ ] Regression test suite
- [ ] Performance validation
- [ ] Release notes generation

---

## Integration Points

### Rust Crate Integration

**stopbus-ui depends on stopbus-core:**

```rust
// Cargo.toml
[dependencies]
stopbus-core = { path = "../stopbus-core" }
```

**Usage Pattern:**
```rust
// In WindowState
struct WindowState {
    game: GameState,  // From stopbus-core
    // ... UI state
}

// In window_proc
let report = state.game.start_fresh();
for event in &report.events {
    // Display to user via MessageBoxW
}
if report.awaiting_human {
    // Enable human interaction
}
```

### Legacy Resource Integration

**Optional Runtime Loading:**
- `stopbus-ui` attempts to load `STOPBUS.RES` at startup
- If successful: uses legacy OS/2 bitmaps (pixel-perfect)
- If fails: falls back to embedded resources (Windows V3)

**Benefit:**
- Allows side-by-side visual comparison with original
- Validates resource extraction process

### Build System Integration

**embed-resource Invocation:**
- `build.rs` compiles `resources/stopbus.rc` at build time
- Resources linked into `.exe` binary
- No separate `.res` file needed for distribution

**Dependency Tracking:**
- `cargo:rerun-if-changed` for all resources
- Incremental builds only recompile changed resources

### Registry Integration

**Persistence:**
- Settings stored in `HKEY_CURRENT_USER\Software\StopBus\Modernization`
- Window positions, cheat window states, save-on-exit flag
- Read on startup, written on exit (if enabled)

---

## Future Roadmap

### Short-Term (Phases D-E)

**Complete Core Logic (Phase D):**
- [ ] Finish turn sequencing
- [ ] Complete life tracking
- [ ] Expand unit test coverage to 90%+
- [ ] Validate scoring matches Pascal exactly

**Polish UI Interaction (Phase E):**
- [ ] Wire all menu commands
- [ ] Implement card drag/drop
- [ ] Add turn animations
- [ ] Verify cheat windows match original

### Medium-Term (Phase F-G)

**Help System Modernization:**
- [ ] Convert WinHelp to HTML5
- [ ] Implement WebView2 viewer OR
- [ ] Implement CHM (Compiled HTML Help) OR
- [ ] Bundle markdown viewer

**Packaging & Distribution:**
- [ ] Automated GitHub Actions builds
- [ ] Signed MSIX package for Microsoft Store
- [ ] Inno Setup installer for classic distribution
- [ ] Create release notes generator

### Long-Term Enhancements

**Optional Features:**
- [ ] DPI awareness and scaling
- [ ] High-resolution card graphics
- [ ] Customizable themes/colors
- [ ] Statistics tracking (games won/lost)
- [ ] Replay system (save/load game state)
- [ ] Network multiplayer (hot-seat or online)

**Quality Improvements:**
- [ ] UI automation tests (WinAppDriver)
- [ ] Performance profiling
- [ ] Memory leak detection
- [ ] Accessibility features (screen reader support)

### Historical Preservation

**Ongoing:**
- [ ] Document all conversion steps
- [ ] Maintain hash checksums for artifacts
- [ ] Archive original distribution media
- [ ] Record gameplay videos (legacy vs. modern)

---

## Conclusion

This comprehensive architecture documentation captures the full scope of the "Stop the Bus" preservation and modernization project. The project successfully balances historical fidelity with modern software engineering practices, demonstrating how legacy software can be respectfully modernized while preserving its original character.

**Key Achievements:**
- Complete preservation of 1993 original codebase
- Faithful Rust reimplementation with 60% core logic complete
- Comprehensive documentation ecosystem
- Clean architectural separation (core vs. UI)
- Robust asset pipeline with provenance tracking

**Next Milestones:**
1. Complete Phase D (core logic port)
2. Implement Phase E (UI interaction)
3. Modernize help system (Phase F)
4. Package and release v2.0 (Phase G)

**For More Information:**
- See individual component docs in `wrk_docs/`
- Review technical docs in `docs/`
- Consult migration plan: `2025.09.20 - Migration & updating plan.md`
- Read contributor guide: `AGENTS.md`

---

**Document Created:** 2025-11-06
**Author:** Claude Code (Sonnet 4.5)
**Project Status:** Phase D (60% complete)
**Next Review:** Upon completion of Phase D
