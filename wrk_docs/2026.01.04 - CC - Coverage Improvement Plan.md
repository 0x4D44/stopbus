# Coverage Improvement Plan: Stop the Bus
**Date:** 2026.01.04
**Target:** >98% Coverage for `stopbus-core`

## Strategy
We will build tests layer by layer, starting from simple state mutations and moving to complex game loop drivers.

## Stage 1: Lifecycle & State Transitions
**Goal:** Verify game initialization, resetting, and basic state flags.
- **Tests to Add:**
    - `test_start_game_resets_lives_and_scores`
    - `test_start_new_round_preserves_lives`
    - `test_apply_stick_valid_and_invalid`
    - `test_human_stick_flow` (updates state, returns correct report)

## Stage 2: Human Interaction Mechanics
**Goal:** Verify the player can interact with the deck and stack correctly.
- **Tests to Add:**
    - `test_human_swap_with_stack_valid` (card moves, score updates)
    - `test_human_swap_invalid_indices`
    - `test_human_draw_next_card` (stack index increments, state flags update)
    - `test_human_draw_deck_overflow`
    - `test_human_cannot_act_when_not_awaiting`

## Stage 3: AI & Automation Logic
**Goal:** Verify the "CPU" players make valid moves.
- **Tests to Add:**
    - `test_ai_sticks_on_high_score`
    - `test_ai_swaps_for_better_card`
    - `test_ai_draws_when_stuck`
    - `test_ai_does_not_swap_for_worse_card`

## Stage 4: Round Finalization & Scoring
**Goal:** Verify the complex rules around ending a round and deducting lives.
- **Tests to Add:**
    - `test_finish_round_lowest_score_loses_life`
    - `test_finish_round_stop_the_bus_protection`
    - `test_finish_round_draw_scenario`
    - `test_game_over_winner_declared`
    - `test_detect_stop_bus_trigger`

## Stage 5: The "Drive" Loop (Integration)
**Goal:** Verify the `drive_round_step` state machine handles sequences correctly.
- **Tests to Add:**
    - `test_drive_full_round_simulation` (scripted RNG/deck to force specific outcome)
    - `test_drive_handles_immediate_win`
    - `test_drive_transitions_players`

## Implementation Protocol
1.  Add tests to `crates/stopbus-core/src/lib.rs`.
2.  Run `cargo test`.
3.  Refactor if bugs are found in the logic.
4.  Commit to `wrk_docs` with progress update.
