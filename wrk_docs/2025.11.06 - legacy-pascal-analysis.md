# Legacy Turbo Pascal Implementation Analysis

**Stop the Bus - Version 1.11 (1993-1994)**

**Document Date:** 2025-11-06

This document provides comprehensive historical documentation of the original 1993 Turbo Pascal implementation.

## Historical Context

### Version History
- v1.0 (12/06/1993) - Initial release
- v1.0a (22/06/1993) - Fixed StopTheBus scoring bug
- v1.0b (20/08/1993) - Fixed stack saving bug
- v1.1 (01/05/1994) - Shareware release with CTL3D
- v1.11 (09/05/1994) - Fixed initialization bug from v1.0

### Technology Stack
- Language: Turbo Pascal for Windows v1.5
- Platform: Windows 3.1
- 3D Controls: CTL3D.DLL
- Graphics: Microsoft card bitmaps
- Author: M G Davidson, Oxford University
- Distribution: Shareware (5 GBP / 10 USD)

## Program Structure

### Source Files
1. STOPBUS.PAS (2,528 lines) - Main program
2. CTL3D.PAS (74 lines) - 3D control interface
3. ABOUT.RC (17 lines) - About dialog

### Class Hierarchy
```
TApplication
  └── TCardApp → creates TMainWindow

TDialog
  ├── TOptions
  └── TAboutBox

TWindow
  ├── TMainWindow (main game)
  ├── TCheatCards (show other players)
  ├── TCheatScores (show scores)
  └── TCheatStack (show deck preview)
```

## Game Logic

### Card Representation
Cards as integers 1-52:
- 1-13: Clubs
- 14-26: Diamonds
- 27-39: Hearts
- 40-52: Spades

### Scoring Functions

ValScore converts card to points:
- Ace = 11
- Jack/Queen/King = 10
- Others = face value

GetScore finds best suited combination of 3 cards.

### AI Strategy

Two-stage approach:
1. Swap if improvement > 5 points AND result > 6
2. After advancing stack, swap on any improvement

Stick if score > 25 and no one stuck yet.

### Shuffling
100-iteration Fisher-Yates shuffle.

## UI Architecture

### Window Layout
Main window: 600x400 pixels

Key positions:
- Stack: (10, 40)
- Top card: (110, 40)
- Player 1 cards: (10, 200), (110, 200), (210, 200)
- Buttons: (400, 200) - (500, 310)

### Graphics
- Green background brush (RGB: 0x008000)
- BitBlt for card rendering
- Custom DrawBMP procedure

## Data Structures

### Global Variables
```pascal
StackPntr: INTEGER;
PlayerToPlay: INTEGER;
PackCard: ARRAY [1..52] OF INTEGER;
RoundScore: ARRAY [1..4] OF INTEGER;
Player: ARRAY [1..4] OF ARRAY [1..3] OF TCard;
Cards: ARRAY [1..52] OF HBitmap;
```

### TCard Record
```pascal
TCard = RECORD
  LButDown: BOOLEAN;
  Card: INTEGER;
  XDefault: INTEGER;
  YDefault: INTEGER;
END;
```

Mixes UI state with game state.

## Resource Management

### INI File Persistence
Uses Windows 3.1 INI file APIs to save:
- Window positions
- Cheat window states
- Save-on-exit flag

### Bitmap Loading
Cards loaded by numeric resource ID (1-54).

### CTL3D
3D control library registered at start, unregistered at exit.

## Message Handling

### Custom Messages
- WM_START (WM_USER + 1) - Start game
- WM_JUSTCASE (WM_USER + 2) - Deferred init

### Deferred Initialization
SetupWindow → WM_JUSTCASE → WM_START → StartGame

Workaround for Windows 3.1 timing issues.

### GameControl Loop
Central loop using LABEL/GOTO for state transitions.

### Mouse Handling
- WM_LBUTTONDOWN: Set flags
- WM_LBUTTONUP: Perform action if still over target

## Comparison with Rust

### Architecture Evolution

| Aspect | Pascal (1993) | Rust (2025) |
|--------|---------------|-------------|
| Paradigm | OOP (OWL) | Functional + ownership |
| State | Global vars | Centralized GameState |
| Control | GOTO | Event-driven |
| Memory | Manual | Automatic Drop |
| UI | OWL | Direct Win32 |
| Settings | INI files | Registry |
| Errors | Nil checks | Result<T,E> |
| Types | Weak | Strong (enums, Option) |

### Preserved Logic
Identical:
- Card numbering (1-52)
- Scoring algorithm
- Shuffle (100 iterations)
- AI threshold (>25)
- Win conditions

### Code Organization
Pascal: Single 2,500-line file with globals
Rust: Separate crates (core/ui), no globals

## 1993-Era Patterns

### Windows 3.1
- Manual DC management
- Null-terminated strings (PChar)
- INI file APIs

### OWL Framework
- Virtual method tables
- Typed pointers (New/Dispose)
- Message response methods

### Commented Code
300 lines of obsolete AutoPlayOld method preserved.

### Bugs Fixed
- v1.0a: Wrong players lost lives
- v1.11: Uninitialized PlayerToPlay

### Defensive Programming
Range checks for corrupted values.

## Summary

The 1993 implementation demonstrates solid engineering for its era. Well-structured, readable, production-tested through 4 releases.

**Strengths:**
- Simple effective AI
- Elegant scoring
- Good debugging (cheat windows)
- Proper OWL usage
- Resource management

**Modernization Benefits:**
- Type safety
- Memory safety
- Clean architecture
- Testability
- Maintainability

**Preserved Fidelity:**
- Exact scoring rules
- AI behavior
- Card representation
- Shuffle randomness
- UI layout
- Game flow

## Key Code Locations

| Function | Lines | Description |
|----------|-------|-------------|
| TMainWindow.Init | 381-437 | Constructor |
| TMainWindow.Done | 440-496 | Destructor |
| TMainWindow.Paint | 607-673 | Rendering |
| TMainWindow.GameControl | 1020-1160 | Main loop |
| TMainWindow.AutoPlay | 1328-1451 | AI logic |
| TMainWindow.Shuffle | 968-988 | Shuffling |
| TMainWindow.Scores | 1843-1958 | Scoring |
| TMainWindow.GetScore | 2086-2124 | Hand score |
| TCheatCards | 2131-2260 | Cards cheat |
| TCheatScores | 2267-2366 | Scores cheat |
| TCheatStack | 2373-2496 | Stack cheat |

---

Document created 2025-11-06 by Claude Code
