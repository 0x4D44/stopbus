# Stop the Bus Project Structure Overview

**Document Date:** 2025-11-06  
**Repository:** stopbus (preservation and modernization)  
**Last Git Commit:** 33b97f3 (Updates)  
**Branch:** main  
**Status:** Clean working directory

---

## Executive Summary

This repository preserves and modernizes "Stop the Bus," a 1993 Windows card game originally written in Turbo Pascal for Windows by Martin Davidson. The project contains both the complete legacy codebase (Pascal sources, resources, WinHelp files, and original binaries) and a modern Rust rewrite using windows-rs that targets Windows 10/11 with feature parity.

**Project Goals:**
1. Preserve the original 1993 release as a documented historical artifact
2. Deliver a fully functional Rust reimplementation with identical gameplay
3. Modernize assets and tooling while maintaining historical fidelity
4. Provide comprehensive documentation for contributors and maintainers

**Current Phase:** Phase C-D (Rust bootstrap complete, core logic port ongoing)

---

## Repository Structure Map

```
stopbus/
├── .git/                           # Git repository metadata
├── .github/
│   └── workflows/
│       └── release.yml             # CI/CD: Automated release builds with Inno Setup
│
├── .gitignore                      # Standard Rust + temp file exclusions
│
├── assets/                         # Extracted and converted resources
│   ├── cards-os2/                  # Original OS/2 format BMPs (card01-54, archival)
│   ├── original-icons/             # Extracted icon resources (ICO/PNG)
│   ├── MD.png                      # Converted main icon
│   ├── stopbus-legacy.ico          # Legacy icon preservation
│   └── stopbus-legacy.png          # Legacy icon as PNG
│
├── crates/                         # Rust workspace (Cargo.toml members)
│   ├── stopbus-core/               # Pure Rust game logic library
│   │   ├── Cargo.toml              # Dependencies: rand (deck shuffling)
│   │   └── src/
│   │       └── lib.rs              # 1071 lines: Game state, scoring, deck management
│   │
│   └── stopbus-ui/                 # Win32 UI executable (windows-rs)
│       ├── Cargo.toml              # Dependencies: stopbus-core, windows 0.58
│       ├── build.rs                # Resource embedding via embed-resource
│       ├── resources/
│       │   ├── stopbus.rc          # Resource definitions (dialogs, menus, icons)
│       │   └── cards/              # Normalized Windows V3 BMPs (card01-54)
│       └── src/
│           └── main.rs             # 2571 lines: Win32 message loop, rendering, UI
│
├── docs/                           # Technical documentation
│   ├── card-bitmap-normalization-log.md    # Asset conversion history
│   ├── help-assets-inventory.md            # WinHelp migration planning
│   ├── resource-embedding-plan.md          # Build-time resource strategy
│   ├── resource-id-map.md                  # Pascal-to-Rust resource ID mapping
│   ├── resource-reuse-plan.md              # Legacy resource reuse approach
│   └── stopbus-architecture-notes.md       # Detailed Pascal code analysis
│
├── HELP/                           # Legacy WinHelp authoring files
│   ├── BMP.ZIP                     # Original help bitmaps (CARDWIND, SCORWIND, etc.)
│   ├── STOPBUS.ERR                 # Help compiler diagnostic log
│   ├── STOPBUS.GID                 # WinHelp runtime index cache
│   ├── STOPBUS.HLP                 # Compiled WinHelp binary (77KB)
│   ├── STOPBUS.HPJ                 # WinHelp 3.1 project definition
│   └── STOPBUS.RTF                 # Help content source (RTF format)
│
├── help_bmp/                       # Extracted help assets
│   ├── CARDWIND.BMP                # Card window screenshot (57KB)
│   ├── MAINICON.BMP                # Icon artwork
│   ├── MAINWIN.SHG                 # Segmented hypergraphic (main window)
│   ├── OPTNWIN.SHG                 # Segmented hypergraphic (options dialog)
│   ├── SCORWIND.BMP                # Score window screenshot
│   └── STACWIND.BMP                # Stack window screenshot
│
├── installers/
│   └── StopTheBus.iss              # Inno Setup installer script (v6)
│
├── RELEASE/                        # Distribution staging folder
│   ├── STOPBUS.TXT                 # Shareware documentation (v1.11 release notes)
│   └── STOPBUS.ZIP                 # Original distribution archive (125KB)
│
├── tools/                          # Build automation and conversion scripts
│   ├── extract_cards.py            # Python: OS/2 BMP to Windows V3 conversion
│   └── update_about_text.py        # Python: Resource text manipulation
│
├── wrk_docs/                       # Working documentation (this file)
│   └── 2025.11.06 - project-structure-overview.md
│
├── 2025.09.20 - Migration & updating plan.md   # Phased modernization roadmap (Phases A-G)
│
├── ABOUT.RC                        # Legacy About dialog resource script
├── AGENTS.md                       # Repository guidelines for contributors/agents
├── Cargo.lock                      # Rust dependency lock file
├── Cargo.toml                      # Workspace definition (stopbus-core, stopbus-ui)
├── CLAUDE.md                       # Claude Code integration guide
├── CTL3D.PAS                       # Pascal wrapper for CTL3D.DLL (3D controls)
├── CTL3D.TPU                       # Compiled Turbo Pascal unit
├── MD.ICO                          # Main application icon (32x32, 16 colors)
├── README.md                       # Project overview and quick start
├── RESOURCE.BAT                    # Legacy resource compiler invocation script
├── STOPBUS.BAK                     # Pascal source backup (69KB)
├── STOPBUS.PAS                     # Main Pascal source (2527 lines)
├── STOPBUS.RES                     # Compiled resource file (100KB binary data)
├── STOPBUS.TXT                     # Original shareware distribution documentation
└── STOPBUS.~RE                     # Secondary Pascal backup (100KB)
```

---

## Documentation Ecosystem

### Primary Documentation Files

#### 1. README.md (Root)
**Purpose:** First-contact documentation for developers  
**Content:**
- Repository layout overview
- Quick start guide for modern Rust build
- Links to migration roadmap and architecture notes
- Licensing information (MIT)
- Instructions for legacy Pascal build (reference only)

**Key Commands:**
```bash
cargo check                    # Fast validation
cargo build --release          # Production build
```

#### 2. AGENTS.md
**Purpose:** Repository guidelines for AI agents and contributors  
**Content:**
- Project structure and module organization
- Build, test, and development commands (legacy and modern)
- Coding style and naming conventions (Pascal vs. Rust)
- Testing guidelines (VM testing, hash validation)
- Commit and pull request guidelines
- Preservation notes (artifact integrity, timestamp retention)

**Key Principles:**
- Retain original timestamps and hashes for legacy binaries
- Keep backups untouched (STOPBUS.BAK, STOPBUS.~RE)
- Document all regenerated files in PRs
- Use certutil for hash validation

#### 3. CLAUDE.md
**Purpose:** Integration guide for Claude Code (claude.ai/code)  
**Content:**
- Project overview (preservation + modernization)
- Complete build command reference (Rust and Pascal)
- Architecture details (Cargo workspace structure)
- Key design principles (separation of concerns, message-driven UI)
- Testing strategy (unit, integration, legacy parity)
- Development workflow (TDD approach)
- Important files and documentation index
- Coding standards (Rust and Pascal)
- Resource management (bitmaps, icons, dialogs)
- Migration status (Phase C-D)
- Platform and tooling requirements
- Key dependencies

**Rust Workspace:**
- stopbus-core: Pure Rust library (game logic, no UI)
- stopbus-ui: Windows executable (windows-rs Win32 bindings)

#### 4. 2025.09.20 - Migration & updating plan.md
**Purpose:** Phased modernization roadmap  
**Content:**
- Objectives (preservation, parity, modernization)
- Current state assessment
- Target architecture overview
- Seven-phase workstream breakdown (A-G)
- Dependencies and tooling requirements
- Risk mitigation strategies
- Immediate action items
- Success criteria

**Phases:**
- A: Reverse Engineering & Documentation (1-2 weeks) - COMPLETE
- B: Asset Extraction & Conversion (1 week) - COMPLETE
- C: Rust Project Bootstrap (1 week) - COMPLETE
- D: Core Logic Port (2-3 weeks) - IN PROGRESS
- E: UI & Interaction Layer (2-3 weeks) - PENDING
- F: Help & Documentation Refresh (1 week) - PENDING
- G: Packaging & QA (1-2 weeks) - PENDING

---

### Technical Documentation (docs/)

#### docs/stopbus-architecture-notes.md
**Last Reviewed:** 2025-09-20  
**Content:**
- High-level structure of legacy Pascal code
- Core types and responsibilities
  - Global records and arrays (TCard, PackCard, Player, RoundScore)
  - TCardApp (application object)
  - Dialogs (TOptions, TAboutBox, cheat windows)
  - TMainWindow (main game controller)
- Resource and UI layout (ABOUT.RC analysis)
- External files and tooling hooks
- Observations for Rust port (message-driven architecture mapping)
- Open questions and follow-up items

**Key Insights:**
- Message-driven architecture maps cleanly to windows-rs WndProc pattern
- Globals need encapsulation in Rust (GameState struct)
- Resource IDs should be enumerated in Rust module
- WinHelp requires replacement (deprecated)

#### docs/resource-id-map.md
**Last Updated:** 2025-09-20  
**Content:**
- Complete mapping of legacy resource IDs
  - IDs 1-52: Card face bitmaps (Clubs to Spades)
  - ID 53: Card back image
  - ID 54: Cross overlay for empty slots
  - IDs 550-556: About dialog controls
  - IDs 998-1003: Menu commands and buttons

**Usage:** Reference for maintaining Pascal-to-Rust resource compatibility

#### docs/help-assets-inventory.md
**Last Reviewed:** 2025-09-20  
**Content:**
- WinHelp asset overview (HPJ, RTF, HLP, ERR, GID, BMP.ZIP)
- Embedded graphics inventory
- Proposed modernization path (5 steps)
  1. Extract BMP.ZIP to assets/help/raw/
  2. Convert SHG files to PNG using shg2bmp
  3. Convert RTF to Markdown/HTML using pandoc
  4. Map WinHelp context IDs to modern help sections
  5. Integrate with build system
- Outstanding questions (interactivity, viewer choice, archival location)

#### docs/resource-embedding-plan.md
**Content:**
- Build-time resource embedding strategy
- stopbus-ui/build.rs behavior (STOPBUS.RES handling)
- Environment flag: EMBED_STOPBUS_RES
- Verification instructions (Resource Hacker, dumpbin)
- CI considerations

#### docs/resource-reuse-plan.md
**Last Updated:** 2025-09-20  
**Content:**
- Goals: Reuse original STOPBUS.RES for pixel-perfect fidelity
- Runtime loading strategy (LoadLibraryExW with LOAD_LIBRARY_AS_DATAFILE)
- Next steps: Helper wrappers, build script updates, gradual migration
- Tooling considerations (Resource Hacker, wrestool)

#### docs/card-bitmap-normalization-log.md
**Date:** 2025-09-22  
**Content:**
- Background: OS/2 BITMAPCOREHEADER format issues
- Problem: 1-bpp images misaligned when loaded by modern Windows
- Solution: tools/extract_cards.py converts to Windows V3 format
  - Preserves originals in assets/cards-os2/
  - Generates normalized BMPs in crates/stopbus-ui/resources/cards/
  - Expands 1-bpp to 4-bpp with 16-entry palette
  - Enforces DWORD-aligned scanlines
- Verification: build.rs enforces >= 40-byte DIB header
- Follow-up: Keep STOPBUS.RES under version control

---

## Development Workflow

### Git Repository State

**Branch:** main (primary development branch)  
**Status:** Clean working directory  
**Recent Commits:**
```
33b97f3 Updates
18b9c5c Windows, not Console app
0b7f6a5 Add resource file
0c27d5c Updated files
0685407 Updated files
```

**Repository Type:** Preservation + active development  
**Collaboration Model:** Single-branch workflow (main)

### Modern Rust Development Workflow

#### Prerequisites
- Rust toolchain: 1.90.0 (stable channel)
- MSVC toolchain (required for windows-rs)
- Windows 10/11 (64-bit) for testing

#### Standard Development Cycle

1. **Validation (Fast)**
   ```bash
   cargo check
   ```
   Validates all crates without full compilation

2. **Build**
   ```bash
   # Debug build
   cargo build
   
   # Release build (optimized)
   cargo build --release
   # Output: target\release\stopbus.exe
   ```

3. **Testing**
   ```bash
   # Run all tests
   cargo test
   
   # Test specific crate
   cargo test -p stopbus-core
   
   # Test specific function
   cargo test <test_name>
   ```

4. **Code Quality**
   ```bash
   # Check formatting
   cargo fmt --check
   
   # Apply formatting
   cargo fmt
   
   # Lint with Clippy (fail on warnings)
   cargo clippy -- -D warnings
   ```

#### Making Changes

**Core Logic Changes (stopbus-core):**
1. Write failing test first (TDD)
2. Implement minimal code to pass test
3. Run `cargo test -p stopbus-core`
4. Refactor while keeping tests green
5. Run `cargo fmt` and `cargo clippy`

**UI Changes (stopbus-ui):**
1. Modify `crates/stopbus-ui/src/main.rs`
2. Update resources in `crates/stopbus-ui/resources/` if needed
3. Ensure `build.rs` embeds resources correctly
4. Build and manually test on Windows 10/11
5. Verify rendering and interactions

**Resource Changes:**
1. Update files in `crates/stopbus-ui/resources/`
2. Modify `stopbus.rc` for dialogs/menus/icons
3. Rebuild (build.rs will embed resources)
4. Verify with Resource Hacker or dumpbin

### Legacy Pascal Workflow (Reference Only)

**Purpose:** Verification and comparison with original behavior  
**Environment:** Windows 3.1/95 VM with Turbo Pascal for Windows 1.5

#### Build Steps
```bash
# Compile resources
rc /r ABOUT.RC
# or
powershell -ExecutionPolicy Bypass -File .\RESOURCE.BAT

# Compile Pascal (requires TPW 1.5 in VM)
tpcw /B STOPBUS.PAS

# Build help file
hc31 HELP\STOPBUS.HPJ
```

**Note:** Legacy builds are for archival purposes only. Active development uses Rust.

### Testing Strategy

#### Unit Testing (stopbus-core)
- **Scope:** All game logic (scoring, deck management, state transitions)
- **Coverage:** Comprehensive tests for edge cases
- **Command:** `cargo test -p stopbus-core`
- **Requirements:** 
  - Test scoring rules match Pascal implementation
  - Validate deck shuffling correctness
  - Verify player state machine transitions

#### Integration Testing (Manual)
**Windows 10/11 Smoke Test:**
1. Launch `target\release\stopbus.exe`
2. Verify menu commands (Game, Help, Options)
3. Play through complete game
4. Test dialogs (Options, About)
5. Verify card rendering and drag/drop
6. Check scoring accuracy
7. Test "Stop the Bus" detection

#### Legacy Parity Testing
**Windows 3.1/95 VM:**
1. Run original `STOPBUS.EXE` in VM
2. Run modern `stopbus.exe` on Windows 10/11
3. Compare behavior side-by-side:
   - Scoring results for identical hands
   - Game flow and state transitions
   - Dialog appearance and behavior
4. Document differences in test notes

**Hash Validation:**
```bash
certutil -hashfile target\release\stopbus.exe SHA256
certutil -hashfile STOPBUS.RES SHA256
certutil -hashfile HELP\STOPBUS.HLP SHA256
```
Record hashes in PR descriptions for reproducibility

### Commit Guidelines

**Format:**
- Imperative 50-character subjects
- Reference issues: `Fixes #n`
- List regenerated artifacts
- Include hash logs for binaries

**Example:**
```
Bootstrap Rust workspace with card rendering

- Add stopbus-core crate for game logic
- Add stopbus-ui crate with Win32 message loop
- Extract card bitmaps from STOPBUS.RES
- Implement resource embedding in build.rs

Tested: cargo check, manual smoke test
Artifacts: target/release/stopbus.exe (SHA256: abc123...)

Fixes #12
```

### Pull Request Process

**PR Description Must Include:**
1. Scope summary (new feature, bug fix, refactoring)
2. Manual verification performed
   - `cargo check` output
   - Legacy EXE comparison (if applicable)
   - Hash logs for changed binaries
3. Changes under RELEASE/ (if any)
4. Links to supporting docs
5. Testing plan and results

**Review Checklist:**
- [ ] Cargo fmt and clippy pass cleanly
- [ ] All tests pass (`cargo test`)
- [ ] Manual smoke test completed
- [ ] Documentation updated (if needed)
- [ ] Resource changes verified
- [ ] No warnings in build output

---

## Migration Timeline and Status

### Overall Progress: Phase C-D (40% Complete)

```
Phase A: Reverse Engineering & Documentation    [████████████████████] 100% COMPLETE
Phase B: Asset Extraction & Conversion          [████████████████████] 100% COMPLETE
Phase C: Rust Project Bootstrap                 [████████████████████] 100% COMPLETE
Phase D: Core Logic Port                        [████████████░░░░░░░░]  60% IN PROGRESS
Phase E: UI & Interaction Layer                 [░░░░░░░░░░░░░░░░░░░░]   0% PENDING
Phase F: Help & Documentation Refresh           [░░░░░░░░░░░░░░░░░░░░]   0% PENDING
Phase G: Packaging & QA                         [░░░░░░░░░░░░░░░░░░░░]   0% PENDING
```

### Phase A: Reverse Engineering & Documentation ✓ COMPLETE

**Duration:** 1-2 weeks  
**Status:** Completed September 2025

**Deliverables:**
- [x] Architecture notes (docs/stopbus-architecture-notes.md)
- [x] Resource ID mapping (docs/resource-id-map.md)
- [x] Event flow analysis (documented in architecture notes)
- [x] Deck structure and scoring rules documentation
- [x] Configuration toggles catalog

**Outputs:**
- Complete Pascal code analysis
- TMainWindow message handler documentation
- Global variable inventory (PackCard, Player, RoundScore)
- Dialog and menu resource enumeration

### Phase B: Asset Extraction & Conversion ✓ COMPLETE

**Duration:** 1 week  
**Status:** Completed September 2025

**Deliverables:**
- [x] STOPBUS.RES decompiled with Resource Hacker
- [x] Card bitmaps extracted (assets/cards-os2/)
- [x] Card bitmaps normalized (crates/stopbus-ui/resources/cards/)
- [x] HELP/BMP.ZIP unpacked (help_bmp/)
- [x] Icon resources extracted (assets/original-icons/)
- [x] Conversion scripts created (tools/extract_cards.py)
- [x] Help migration proof-of-concept (docs/help-assets-inventory.md)

**Outputs:**
- 54 card bitmaps (card01-52, CardBack, CardCross)
- OS/2 format preservation in assets/cards-os2/
- Windows V3 format in crates/stopbus-ui/resources/cards/
- Help artwork extracted (CARDWIND.BMP, SCORWIND.BMP, etc.)
- Icon conversions (ICO to PNG)

**Technical Achievement:**
- Solved OS/2 BITMAPCOREHEADER compatibility issue
- 1-bpp to 4-bpp expansion with proper alignment
- Automated conversion pipeline (Python script)

### Phase C: Rust Project Bootstrap ✓ COMPLETE

**Duration:** 1 week  
**Status:** Completed September 2025

**Deliverables:**
- [x] Cargo workspace initialized
- [x] stopbus-core crate created (library)
- [x] stopbus-ui crate created (executable)
- [x] Windows bindings integrated (windows 0.58)
- [x] Window class registered
- [x] Message loop implemented
- [x] Resource build pipeline (build.rs with embed-resource)
- [x] Minimal UI displays (empty main window)
- [x] About dialog stub

**Technical Stack:**
- Cargo workspace (resolver = "2")
- windows = "0.58" with Win32 features
- rand = "0.8" for shuffling
- embed-resource = "3.0" for build-time embedding

**Current Build Output:**
- target\release\stopbus.exe (functional executable)
- Embedded resources (bitmaps, dialogs, icons)
- Debug symbols in debug builds

### Phase D: Core Logic Port ⚙ IN PROGRESS (60%)

**Duration:** 2-3 weeks (estimated)  
**Status:** Ongoing

**Completed:**
- [x] Deck and card structures
- [x] Shuffling algorithm (using rand crate)
- [x] Player state representation
- [x] Basic scoring logic
- [x] Configuration options structure

**In Progress:**
- [ ] Turn sequencing logic
- [ ] Life tracking system
- [ ] Complete scoring rules (31 triggers "Stop the Bus")
- [ ] Game state machine (round transitions)
- [ ] Unit test coverage

**Pending:**
- [ ] Cheat toggles implementation
- [ ] Save-on-exit configuration
- [ ] Configuration serialization/deserialization
- [ ] Full parity testing against Pascal outcomes

**Files:**
- crates/stopbus-core/src/lib.rs (1071 lines)

**Testing Requirements:**
- Unit tests for all scoring scenarios
- Deck shuffling validation
- Player state transition tests
- Edge case coverage

### Phase E: UI & Interaction Layer (PENDING)

**Duration:** 2-3 weeks (estimated)  
**Status:** Not started

**Planned Deliverables:**
- [ ] Menu commands wired to core logic
- [ ] Toolbar implementation (if applicable)
- [ ] Dialog implementations (Options, About, Cheat windows)
- [ ] CTL3D visual treatment (manifest or modern theming)
- [ ] Drag/drop card interactions
- [ ] Event handlers connected to game logic
- [ ] GDI rendering (BitBlt for cards, TextOut for scores)
- [ ] Main window painting complete

**Technical Challenges:**
- Message handler organization (WndProc pattern)
- Resource handle management
- Card animation and drag/drop
- Window state encapsulation

**Target:** Feature parity with 1994 UI

### Phase F: Help & Documentation Refresh (PENDING)

**Duration:** 1 week (estimated)  
**Status:** Not started

**Planned Deliverables:**
- [ ] WinHelp content converted to modern format (HTML or Markdown)
- [ ] Help viewer implementation (WebView2 or browser launch)
- [ ] STOPBUS.TXT updated with Rust rebuild steps
- [ ] AGENTS.md finalized
- [ ] User documentation complete
- [ ] Context-sensitive help mapping

**Conversion Strategy:**
1. Use pandoc to convert HELP/STOPBUS.RTF to Markdown
2. Extract WinHelp metadata (context IDs, browse sequences)
3. Preserve topic structure
4. Convert SHG hypergraphics to annotated screenshots
5. Integrate with build system

### Phase G: Packaging & QA (PENDING)

**Duration:** 1-2 weeks (estimated)  
**Status:** Not started

**Planned Deliverables:**
- [ ] Automated build scripts (GitHub Actions)
- [ ] Inno Setup installer (already configured in installers/StopTheBus.iss)
- [ ] Signed MSIX or ZIP package
- [ ] Release notes generation
- [ ] Regression test suite (Windows 10/11)
- [ ] Optional 32-bit VM testing
- [ ] Screenshot and gameplay recordings
- [ ] Hash checksums for artifacts
- [ ] CI/CD pipeline complete

**Existing Infrastructure:**
- .github/workflows/release.yml (configured)
- installers/StopTheBus.iss (Inno Setup 6 script)
- RELEASE/ staging folder

**Quality Assurance:**
- Full gameplay testing on Windows 10/11
- Legacy comparison in Windows 3.1/95 VM
- Performance validation
- Resource leak testing
- Dialog behavior verification

---

## Repository Organization Rationale

### Preservation-First Design Philosophy

The repository organization reflects a dual mandate: **historical preservation** and **active modernization**. This design intentionally keeps legacy and modern artifacts distinct while maintaining clear relationships between them.

#### Root-Level Legacy Files (Intentional)

**Why legacy files remain at root:**
1. **Historical accuracy:** Mirrors the original 1993 project structure
2. **Easy comparison:** Developers can quickly reference original Pascal code
3. **Archival integrity:** Original file locations preserved for documentation
4. **Build parity:** Legacy build scripts (RESOURCE.BAT) reference root paths

**Legacy Artifacts at Root:**
- STOPBUS.PAS (main source)
- STOPBUS.BAK, STOPBUS.~RE (backups - never modified)
- STOPBUS.RES (compiled resources - reused by modern build)
- CTL3D.PAS, CTL3D.TPU (3D control library)
- ABOUT.RC (dialog resources)
- MD.ICO (application icon)
- STOPBUS.TXT (original documentation)

#### Modern Development in crates/ (Separation of Concerns)

**Rationale:**
- Clear distinction between legacy and modern code
- Standard Rust workspace organization
- Enables incremental testing (core vs. UI)
- Clean dependency graph (UI depends on core, not vice versa)

**Benefits:**
1. **Parallel development:** Core logic and UI can evolve independently
2. **Unit testing:** Core library has no UI dependencies
3. **Reusability:** stopbus-core could be used by alternate frontends
4. **Build optimization:** Cargo only rebuilds changed crates

#### Documentation Hierarchy

**Three-tier structure:**

1. **Root-level guides** (first contact):
   - README.md (quick start)
   - AGENTS.md (contributor guidelines)
   - CLAUDE.md (AI agent integration)
   - 2025.09.20 - Migration & updating plan.md (strategic roadmap)

2. **docs/ technical details** (implementation reference):
   - Architecture notes (Pascal code analysis)
   - Resource mappings (ID tables)
   - Asset conversion logs (provenance)
   - Build strategies (embedding, reuse)

3. **wrk_docs/ working documents** (in-progress analysis):
   - Project overviews (like this document)
   - Design explorations
   - Test plans

**Rationale:**
- Decreasing generality as you descend (README → docs → wrk_docs)
- Quick reference at root, deep dives in subdirectories
- Working docs separate from stable documentation

#### Asset Organization

**Three-tier preservation:**

1. **assets/** - Extracted/converted resources (version controlled)
   - cards-os2/ (original OS/2 format - archival)
   - original-icons/ (extracted from STOPBUS.RES)
   - Converted formats (PNG) for modern use

2. **crates/stopbus-ui/resources/** - Build-time embedded resources
   - cards/ (normalized Windows V3 BMPs)
   - stopbus.rc (resource definitions)
   - Active resources used by compilation

3. **HELP/, help_bmp/** - Legacy help system (reference)
   - Original WinHelp project (HPJ, RTF, HLP)
   - Extracted help bitmaps
   - Awaiting Phase F conversion

**Rationale:**
- Original formats preserved for provenance
- Normalized formats for modern builds
- Clear conversion pipeline (assets → crates/resources)
- Enables gradual migration without losing history

#### Tools and Automation

**tools/ directory:**
- extract_cards.py (OS/2 to Windows V3 conversion)
- update_about_text.py (resource manipulation)

**Rationale:**
- Reproducible asset generation
- Version-controlled conversion process
- Documented transformation steps
- Enables regeneration if source changes

#### Release Infrastructure

**RELEASE/ staging folder:**
- Original distribution (STOPBUS.ZIP)
- Release notes (STOPBUS.TXT)
- Future: Modern build artifacts

**installers/ configuration:**
- StopTheBus.iss (Inno Setup script)

**.github/workflows/ automation:**
- release.yml (CI/CD pipeline)

**Rationale:**
- Centralized release artifacts
- Automated build and packaging
- Reproducible distribution process
- Historical comparison capability

### File Categorization: Legacy vs. Modern

#### Legacy (Preserve, Do Not Modify)

**Source Code:**
- STOPBUS.PAS (2527 lines)
- CTL3D.PAS
- CTL3D.TPU

**Resources:**
- STOPBUS.RES (100KB binary)
- ABOUT.RC
- MD.ICO

**Backups (Critical - Never Touch):**
- STOPBUS.BAK
- STOPBUS.~RE

**Documentation:**
- STOPBUS.TXT (original shareware docs)
- HELP/STOPBUS.RTF (WinHelp source)
- HELP/STOPBUS.HLP (compiled help)

**Build Scripts:**
- RESOURCE.BAT (historical reference)

**Distribution:**
- RELEASE/STOPBUS.ZIP (original package)

#### Modern (Active Development)

**Source Code:**
- crates/stopbus-core/src/lib.rs (1071 lines)
- crates/stopbus-ui/src/main.rs (2571 lines)
- crates/stopbus-ui/build.rs (59 lines)

**Configuration:**
- Cargo.toml (workspace)
- crates/*/Cargo.toml (crate configs)
- Cargo.lock (dependencies)

**Resources:**
- crates/stopbus-ui/resources/cards/ (54 normalized BMPs)
- crates/stopbus-ui/resources/stopbus.rc
- assets/ (extracted/converted resources)

**Documentation:**
- docs/ (technical documentation)
- wrk_docs/ (working documents)
- AGENTS.md, CLAUDE.md (living documents)

**Tooling:**
- tools/*.py (conversion scripts)
- installers/StopTheBus.iss
- .github/workflows/release.yml

#### Hybrid (Reference and Reuse)

**STOPBUS.RES:**
- Legacy binary resource file
- Reused by modern build (runtime loading)
- Source for extraction/conversion
- Preserved for archival

**HELP/ directory:**
- Legacy WinHelp system (reference)
- Source for modern help conversion
- Original files preserved

---

## Integration Architecture

### How All Pieces Fit Together

The project integrates legacy preservation with modern development through multiple layers.

#### 1. Code Analysis Flow

STOPBUS.PAS undergoes manual analysis by developers to extract message handlers, global state, and game logic. This analysis is documented in docs/stopbus-architecture-notes.md, which serves as a reference for the Rust implementation in crates/stopbus-core/src/lib.rs where Rust structs mirror Pascal types.

#### 2. Resource Flow

STOPBUS.RES (100KB binary) feeds into tools/extract_cards.py which reads RT_BITMAP resources (IDs 1-54), detects OS/2 BITMAPCOREHEADER format, and converts to Windows V3 DIB. Results are stored in assets/cards-os2/ for archival and crates/stopbus-ui/resources/cards/ for active use. The stopbus.rc file references these bitmaps, and build.rs uses embed-resource to compile them into the final executable.

#### 3. Build Flow

When a developer runs cargo build --release:
- Cargo resolves the workspace
- stopbus-core (library) compiles game logic and runs unit tests
- stopbus-ui (binary) compiles UI code and executes build.rs
- build.rs invokes embed-resource to compile stopbus.rc
- Resources (card bitmaps, dialogs, icons) are linked into the executable
- Result: target/release/stopbus.exe with embedded resources

#### 4. Testing Flow

Unit Testing: cargo test -p stopbus-core tests scoring, shuffling, and state machine

Integration Testing: Run target/release/stopbus.exe for smoke tests on Windows 10/11, compare with STOPBUS.EXE in VM, document differences

CI Testing: GitHub Actions workflow builds release, runs tests, and creates installer with Inno Setup

### Component Dependencies

#### Rust Workspace Dependencies

stopbus-ui (executable) depends on:
- stopbus-core (internal library)
- windows = "0.58" with Win32 features (Foundation, WindowsAndMessaging, Gdi, LibraryLoader, Registry, Input)
- embed-resource = "3.0" (build dependency)

stopbus-core (library) depends on:
- rand = "0.8" with std feature for deck shuffling

#### External Tool Dependencies

Development: Rust 1.90.0 stable, MSVC toolchain, Python 3.x for conversion scripts

Legacy Verification: Windows 3.1/95 VM, Turbo Pascal for Windows 1.5, Borland Resource Compiler, Microsoft Help Compiler 3.1

Packaging: Inno Setup 6, GitHub Actions

Resource Inspection: Resource Hacker (GUI), dumpbin (CLI)

### Integration Points

#### 1. Game Logic Integration

stopbus-ui calls stopbus-core library functions for game state management. The core library exposes a public API for deck shuffling, card dealing, scoring calculations, player state queries, and round/game progression. The UI layer handles rendering and user input while the core handles pure logic with no UI dependencies.

#### 2. Resource Integration

Legacy STOPBUS.RES provides bitmap data that tools/extract_cards.py converts to modern format. The stopbus.rc file references converted bitmaps, and build.rs embeds them at compile time. At runtime, the UI uses LoadBitmapW with MAKEINTRESOURCEW to access embedded resources by ID (1-54).

#### 3. Documentation Integration

Developers read docs/stopbus-architecture-notes.md to identify Pascal message handlers (like CMGameDeal) and implement Rust equivalents in the WndProc message handler, mapping Pascal commands to WM_COMMAND messages.

#### 4. CI/CD Integration

When a developer creates and pushes a git tag (v2.0.0), GitHub Actions automatically triggers the release workflow, builds the executable, runs Inno Setup to create an installer, and uploads artifacts to the GitHub Release.

---

## Historical Artifacts and Preservation

### Original Release Context

**Game Title:** Stop the Bus  
**Original Version:** v1.11 (released May 9, 1994)  
**Author:** Martin Davidson, Hertford College, Oxford  
**Platform:** Windows 3.1/95  
**Technology:** Turbo Pascal for Windows 1.5, CTL3D library  
**Distribution:** Shareware (5 UK pounds or $10 USD)  
**License:** MIT (modern release)

### Preserved Artifacts

#### Source Code Backups

**STOPBUS.BAK (69,450 bytes)**
- Backup of Pascal source
- NEVER modified in modernization
- Preserved for historical comparison
- May contain different code states

**STOPBUS.~RE (100,237 bytes)**
- Secondary backup file
- NEVER modified in modernization
- Likely resource or intermediate compilation artifact
- Retained for archival purposes

**Preservation Policy:**
- These files are frozen in time
- Git tracks but never modifies them
- Serve as reference for code archaeology
- Enable comparison with active STOPBUS.PAS

#### Compiled Resources

**STOPBUS.RES (100,229 bytes)**
- Compiled resource file from 1993 build
- Contains all bitmaps, dialogs, menus, icons
- Binary format (data file)
- Status: PRESERVED and REUSED

**Reuse Strategy:**
1. Extraction: tools/extract_cards.py reads bitmap data
2. Conversion: OS/2 format → Windows V3 format
3. Archival: Original BMP headers preserved in assets/cards-os2/
4. Modern Use: Normalized BMPs in crates/stopbus-ui/resources/cards/

**Technical Details:**
- Contains 54 BITMAP resources (cards + back + cross)
- Uses OS/2 BITMAPCOREHEADER format (3-byte palette entries)
- 1-bpp images for number cards (red)
- 4-bpp images for face cards
- Original resource IDs preserved (1-54)

#### WinHelp System

**HELP/STOPBUS.HLP (77,127 bytes)**
- Compiled Windows Help file (WinHelp 3.1)
- Used by original STOPBUS.EXE
- Deprecated format (not supported on Windows 10+)
- Preserved for reference
- Will be converted in Phase F

**HELP/STOPBUS.RTF (18,128 bytes)**
- Rich Text Format source for help content
- Contains all help topics
- Uses WinHelp footnotes for:
  - Keywords (K footnote)
  - Browse sequences (+ footnote)
  - Context IDs (# footnote)
- Target for pandoc conversion to Markdown/HTML

**HELP/STOPBUS.HPJ (367 bytes)**
- WinHelp 3.1 project definition
- Maps topic IDs (e.g., options = 1)
- Defines window profiles (main window, gray background)
- Links RTF source to bitmap assets

**HELP/BMP.ZIP (16,692 bytes)**
- Archive of help system graphics
- Contains:
  - CARDWIND.BMP (card window screenshot, 57KB)
  - SCORWIND.BMP (score window, 17KB)
  - STACWIND.BMP (stack window, 24KB)
  - MAINICON.BMP (icon artwork, 2KB)
  - MAINWIN.SHG (segmented hypergraphic, 30KB)
  - OPTNWIN.SHG (options hypergraphic, 10KB)
- Extracted to help_bmp/ for access
- SHG files require specialized conversion (shg2bmp tool)

#### Original Distribution

**RELEASE/STOPBUS.ZIP (125,205 bytes)**
- Original shareware distribution package
- Mirrors 1994 release structure
- Contains (or should contain):
  1. STOPBUS.EXE (original Pascal executable)
  2. STOPBUS.HLP (help file)
  3. STOPBUS.TXT (documentation)
  4. CTL3D.DLL (Microsoft 3D control library)
- Preserved as reference for packaging modern release

**STOPBUS.TXT (root and RELEASE/)**
- Original shareware documentation
- Installation instructions for Windows 3.1/95
- Author contact information (Oxford email, 1995 expiry noted)
- Licensing terms (5 pounds / $10 USD)
- Disclaimer text
- File manifest

**RELEASE/STOPBUS.TXT (601 bytes)**
- Abbreviated release notes for v1.11
- Upload announcement (May 9, 1994)
- Notes CTL3D.DLL inclusion (fixed from v1.1)

#### Legacy Build System

**RESOURCE.BAT (38 bytes)**
- DOS batch script
- Contains: `h:\language\tpw\utils\rc stopbus.res`
- References Turbo Pascal for Windows installation path
- Historical artifact showing original build environment
- Not used in modern builds (replaced by build.rs)

**CTL3D.PAS (2,763 bytes) and CTL3D.TPU (1,424 bytes)**
- Pascal wrapper for CTL3D.DLL
- Provides 3D visual effects for Windows 3.1 controls
- TPU is compiled Turbo Pascal unit
- Modern build uses Windows theming instead
- Preserved for legacy build capability

**ABOUT.RC (647 bytes)**
- Resource script for About dialog
- Contains copy/paste artifact: "About Nonogram Solver" in caption
- Should be "About Stop the Bus" (documented issue)
- Defines dialog layout (157x119 dialog units)
- Control IDs 550-556 for text fields
- References ICON_1 and ICON_2
- Modern version corrects caption in crates/stopbus-ui/resources/stopbus.rc

#### Asset Conversions

**assets/cards-os2/ (54 files, varying sizes)**
- Original OS/2 format bitmaps extracted from STOPBUS.RES
- BITMAPCOREHEADER structure (12-byte header)
- 3-byte palette entries
- Preserved for provenance and comparison
- File sizes vary: 1184 bytes (1-bpp), 3530-3574 bytes (4-bpp)

**assets/original-icons/ (4 files)**
- icon_001.ico (766 bytes) and icon_001.png (433 bytes)
- icon_002.ico (766 bytes) and icon_002.png (280 bytes)
- Extracted from STOPBUS.RES
- ICO and PNG versions for maximum compatibility
- Used as reference for modern icon design

**MD.ICO (766 bytes) and assets/MD.png (280 bytes)**
- Main application icon
- 32x32 pixels, 16 colors
- MS Windows icon resource format
- PNG conversion available for modern use

### Preservation Practices

#### Version Control Strategy

**Git Tracking:**
- All legacy files tracked in repository
- Original timestamps documented (where possible)
- Backups (BAK, ~RE) committed but never modified
- Binary files tracked with Git LFS consideration

**Commit Guidelines for Preservation:**
- Never modify legacy source without explicit permission
- Document any regenerated artifacts in commit messages
- Include hash checksums for binary files
- Reference original versions in PR descriptions

#### Hash Documentation

**Critical Files to Hash:**
```bash
certutil -hashfile STOPBUS.RES SHA256
certutil -hashfile STOPBUS.BAK SHA256
certutil -hashfile STOPBUS.~RE SHA256
certutil -hashfile HELP\STOPBUS.HLP SHA256
certutil -hashfile RELEASE\STOPBUS.ZIP SHA256
```

Include these hashes in:
- PR descriptions when files are touched
- Release notes for modern versions
- Documentation for provenance

#### Archival Documentation

**Repository serves as:**
1. Working codebase (active Rust development)
2. Historical archive (1993 original preserved)
3. Educational resource (Pascal-to-Rust case study)
4. Provenance chain (asset transformations documented)

**Documentation Requirements:**
- All asset conversions logged (docs/card-bitmap-normalization-log.md)
- Tool provenance recorded (tools/extract_cards.py with comments)
- Conversion steps reproducible (Python scripts version controlled)
- Original formats retained alongside modern versions

### Historical Context Notes

**About Dialog Caption Issue:**
- ABOUT.RC contains "About Nonogram Solver" instead of "About Stop the Bus"
- Likely copy/paste from another project
- Documented in docs/stopbus-architecture-notes.md
- Corrected in modern Rust version

**1993 Development Environment:**
- Turbo Pascal for Windows 1.5 (Borland)
- Windows 3.1 SDK
- Borland Resource Compiler (rc.exe)
- Microsoft Help Compiler 3.1 (hc31.exe)
- CTL3D.DLL for visual theming

**Original Author Context:**
- Written by Martin Davidson, Oxford student
- Second year project (1993), revised for Finals (1994)
- Shareware model (honor system payment)
- Email addresses expired July 1995
- Other projects mentioned: Estimation Whist (in progress)

**License Evolution:**
- Original: Shareware with optional payment
- Modern: MIT license (open source)
- Preserves author attribution
- Enables community contributions

---

